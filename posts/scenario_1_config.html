<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>Matthew Castro - Blog</title>
    <link rel="icon" type="image/x-icon" href="../assets/favicon.ico" />
    <!-- Font Awesome icons (free version)-->
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <!-- Google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet"
        type="text/css" />
    <link
        href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"
        rel="stylesheet" type="text/css" />
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="../css/styles.css" rel="stylesheet" />
    <link rel="preload" as="image" href="/assets/img/backgroud.jpg">
    <link rel="preload" as="image" href="/assets/img/posts.jpg">
</head>

<body>
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-light" id="mainNav">
        <div class="container px-4 px-lg-5">
            <a class="navbar-brand" href="../index.html">Matthew Castro</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarResponsive"
                aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                Menu
                <i class="fas fa-bars"></i>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto py-4 py-lg-0">
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="../index.html">Homelab</a></li>
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="../reports.html">Reports</a></li>
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="../Write-ups.html">Write-ups</a></li>
                        <li class="nav-item"><a class="nav-link px-lg-3 py-3 py-lg-4" href="../about.html">About</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- Page Header-->
    <header class="masthead" style="background-image: url('../assets/img/posts.jpg')">
        <div class="container position-relative px-4 px-lg-5">
            <div class="row gx-4 gx-lg-5 justify-content-center">
                <div class="col-md-10 col-lg-8 col-xl-7">
                    <div class="post-heading">
                        <h1>Configuring Attack Chain #1</h1>
                        <h2 class="subheading">All of the steps taken in configuring attack chain #1.</h2>
                        <span class="meta">
                            Posted on December 13th, 2025
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- Post Content-->
    <article class="mb-4">
        <div class="container px-4 px-lg-5">
            <div class="row gx-4 gx-lg-5 justify-content-center">
                <div class="col-md-10 col-lg-8 col-xl-7">

                    <h2 id="table-of-contents">Table of Contents</h2>
                    <ul>
                        <li><a href="#introduction">Introduction</a></li>
                        <li><a href="#attack-chain-summary">Attack Chain Summary</a></li>
                        <li><a href="#configuration">Configuration</a>
                            <ul>
                                <li><a href="#setting-an-insecure-password-for-user-evan-mercer">Setting an Insecure
                                        Password for User Evan Mercer</a></li>
                                <li><a href="#testing-password-crackability">Testing Password Crackability</a></li>
                                <li><a href="#placing-credentials-on-the-domain-network-drive">Placing Credentials on
                                        the Domain Network Drive</a></li>
                                <li><a href="#adding-user-daniel-rowe-to-local-groups-on-pc01">Adding User “Daniel Rowe”
                                        to Local Groups on PC01</a></li>
                                <li><a href="#setting-the-local-administrator-password-on-pc01-and-pc02">Setting the
                                        Local Administrator Password on PC01 and PC02</a></li>
                                <li><a href="#testing-hash-extraction">Testing Hash Extraction</a></li>
                                <li><a href="#testing-winrm-on-pc01-and-pc02-with-pass-the-hash">Testing WinRM on PC01
                                        and PC02 with Pass-the-Hash</a></li>
                                <li><a href="#setting-adrian-cole-s-password-and-domain-group-membership">Setting Adrian
                                        Cole’s Password and Domain Group Membership</a></li>
                                <li><a href="#logging-into-pc02-as-adrian-cole">Logging into PC02 as Adrian Cole</a>
                                </li>
                            </ul>
                        </li>
                        <li><a href="#conclusion">Conclusion</a>
                        </li>
                    </ul>
                    <h2 id="introduction">Introduction</h2>
                    <p>In this document, we outline the configuration of all vulnerabilities required in
                        attack chain #1. A complete pentesting report covering the full exploitation is
                        available <a class="" href="../reports.html">here</a>.</p>
                    <p>This document assumes the reader has basic knowledge of Windows/Active Directory security
                        concepts.</p>
                    <p>We will be adding onto the base configuration of the home lab detailed in the document
                        “Installing and Configuring my Home Lab”.</p>
                    <h2 id="attack-chain-summary">Attack Chain Summary</h2>
                    <p>This will be an assumed breach scenario, where our Kali machine is already located within the
                        internal network.
                    </p>
                     Below is a layout of the homelab network.
                    <p></p>
                    <img class="img-fluid" src="../assets/img/hl_setup/internal1.png" alt="..." />

                    <p>The attack chain we are configuring is the following:</p>
                    <p>As the attacker, we will first scan the machines on the network and find an open mail server on
                        DC01. It is assumed that we have been provided the email address “emercer@homelab.local” before starting
                         the assessment.
                    </p>
                    <p> We will send a phishing email to user <b>emercer</b> containing
                        a link to a file that references a fake SMB server we control. Once the user downloads and opens the file,
                         we capture his NTLMv2 hash. 
                         In this scenario, the user’s password is contained within a common password list
                        which allows us to crack it.</p>
                    <p>Using the obtained credentials, we gain access to a network drive on the domain. On it, we find
                        an installation script that contains user <b>acole's</b> cleartext password.</p>
                    <p>This user happens to be part of the “Remote Management Users” group and the “Backup Operators”
                        group on PC01.</p>
                    <p>Leveraging the permissions associated with the “Backup Operators” local group, we dump PC01’s SAM
                        and SYSTEM registry hives and save them to our Kali machine. We then extract the local hashes contained in the SAM registry using Impacket’s secretsdump
                        utility.</p>
                    <p>PC01 and PC02 will be configured to share the local administrator password. We can now use the
                        Pass-the-Hash attack to connect via WinRM to PC02 as the local admin.</p>
                    <p>We use Mimikatz to dump cached credentials on PC02 and obtain the MSCacheV2 hash of domain user
                        <b>acole</b>.</p>
                    <p>We crack the hash with Hashcat and obtain the user’s password. We check the user’s domain group
                        membership to find that he is part of the domain admins group. We now have full control over the
                        domain.</p>
                    <h2 id="configuration">Configuration</h2>
                    <h4 id="setting-an-insecure-password-for-user-evan-mercer">Setting an Insecure Password for User
                        Evan Mercer</h4>
                    <p>
                        The
                        hash we capture in this step will be an NTLMv2 hash. Although this type of hash is more secure
                        than older Windows hashing algorithms, it can still be cracked if the underlying password is weak or contained
                        within a password wordlist.
                    </p>
                    <p>
                        We will be setting the password of user emercer to “06041992”, which corresponds to line 20000 of
                        the xato-net-top-10-million-passwords wordlist. This is meant to simulate a domain user whose
                        password appears in common password wordlists.
                    </p>
                    <p>
                        We can see the password being selected from the list here:
                    </p>

                    <img class="img-fluid" src="../assets/img/attck_1/1.png" alt="..." />

                    <p>While trying to set the password for the user on the DC, I got this error:
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/2.png" alt="..." />
                    <p>
                        We will change the domain password policy so that it accepts the password we are trying to set.
                        This is a common practice in real life Active Directory environments.
                    </p>
                    <p>
                        We set the “Password must meet complexity requirements” policy to “disabled” in the default
                        domain policy.
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/3.png" alt="..." />
                    <p>We run “gpupdate /force” in CMD on the DC to apply the policy and try to set the password again.
                    </p>
                    <p>It works.</p>
                    <img class="img-fluid" src="../assets/img/attck_1/4.png" alt="..." />
                    <p></p>
                    <h4 id="testing-password-crackability">Testing Password Crackability</h4>
                    <p>We now test if we can crack the password. We can do this by starting Responder on our Kali
                        machine and entering the Kali machine IP address into Explorer on PC01. We then obtain the
                        NTLMv2 hash in Responder and crack it with Hashcat.</p>
                    <p>(This is simplified for testing purposes, in our attack chain user “emercer” will open a file
                        from a phishing email instead of entering the attacker machine IP manually).
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/5.png" alt="..." />
                    <p>
                        We capture the hash on our Kali machine:
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/6.png" alt="..." />
                    <p>
                        The hash is cracked successfully as intended.
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/7.png" alt="..." />
                    <p></p>
                    <h4 id="placing-credentials-on-the-domain-network-drive">Placing Credentials on the Domain Network
                        Drive</h4>
                    <p>We then place user Daniel Rowe’s credentials in a PowerShell script on the domain network drive
                        “LabDrive”.
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/8.png" alt="..." />
                    <p>
                        This allows lateral movement from one domain user to another within the network. The presence of
                        cleartext credentials on a network drive simulates a common but dangerous occurrence in
                        real-world environments.
                    </p>
                    <h4 id="adding-user-daniel-rowe-to-local-groups-on-pc01">Adding User “Daniel Rowe” to Local Groups
                        on PC01</h4>
                    <p>We add user “<b>drowe</b>” to the “Remote Management Users” local group on PC01. This will allow us to
                        connect to the computer from our Kali machine over WinRM once we obtain the user’s credentials.
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/9.png" alt="..." />
                    <p>
                        We also add user “<b>drowe</b>” to the Backup Operators group, granting the necessary privileges to
                        dump the local SAM and SYSTEM registry hives. This will serve as the privilege escalation
                        vector.
                 
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/10.png" alt="..." />
                    <p></p>
                    <h4 id="setting-the-local-administrator-password-on-pc01-and-pc02">Setting the Local Administrator
                        Password on PC01 and PC02</h4>
                    <p>We set the password for the local administrator account on both PC01 and PC02 to
                        “M4r!onH-72bQ$eL9”. The goal of this password is to demonstrate that password complexity and
                        length will not prevent abuse when an attacker is using the Pass-the-Hash technique.
                        </p>
                    <img class="img-fluid" src="../assets/img/attck_1/11.png" alt="..." />
                    <p></p>
                    <img class="img-fluid" src="../assets/img/attck_1/12.png" alt="..." />
                    <p></p>
                    <h4 id="testing-hash-extraction">Testing Hash Extraction</h4>
                    <p>From our Kali machine, we test dumping the SAM and SYSTEM registry hives on PC01. In the
                        following screen capture, a connection via WinRM as user “<b>drowe</b>” has already been established to
                        PC01.
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/13.png" alt="..." />
                    <p>
                        We then extract the local administrator NTLM hash using Impacket’s secretsdump utility.
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/14.png" alt="..." />
                    <p></p>
                    <h4 id="testing-winrm-on-pc01-and-pc02-with-pass-the-hash">Testing WinRM on PC01 and PC02 with
                        Pass-the-Hash</h4>
                    <p>We verify that we can authenticate via WinRM on both PC01 and PC02 using Pass-the-Hash with the
                        local administrator hash.
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/15.png" alt="..." />
                    <p></p>
                    <img class="img-fluid" src="../assets/img/attck_1/16.png" alt="..." />
                    <p>
                        It works as expected.
                    </p>
                    <h4 id="setting-adrian-cole-s-password-and-domain-group-membership">Setting Adrian Cole’s Password
                        and Domain Group Membership</h4>
                    <p>
                        We add user Adrian Cole to the “Domain Admins” group.
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/17.png" alt="..." />
                    <p>
                        We set the user’s password to “Bearing1!”. This is a modified version of a password found in the
                        common passwords list we used in the previous step. In our scenario, this password is cracked
                        using Hashcat with a rule file.
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/18.png" alt="..." />
                    <p>
                        This is the content of the Hashcat rule file:
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/19.png" alt="..." />
                    <p>
                        The rule file will modify each entry of the wordlist by capitalizing the first character and
                        appending “1!” to the end.
                    </p>
                    <h4 id="logging-into-pc02-as-adrian-cole">Logging into PC02 as Adrian Cole</h4>
                    <p>We log in to PC02 as domain user “<b>acole</b>” to ensure that the credentials are cached locally as an
                        MSCacheV2 hash. Windows caches domain credentials locally so that users can log in when the
                        domain controller cannot be contacted for authentication.</p>
                    <p>We will be using Mimikatz to extract this hash. Windows Defender will be disabled on PC02 to facilitate our attack. Using
                        Mimikatz while Windows Defender or any other EDR is active is possible but takes a great deal of
                        obfuscation and is out of scope for this attack chain.</p>
                    <p>We now connect to PC02 via WinRM as the local administrator, upload Mimikatz and attempt to
                        extract the hash.</p>
                    <img class="img-fluid" src="../assets/img/attck_1/20.png" alt="..." />
                    <p>User Adrian Cole’s hash can be seen in the command results:
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/21.png" alt="..." />
                    <p>
                        We verify that the hash is crackable with Hashcat:
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/22.png" alt="..." />
                    <p>It works.</p>
                    <p>
                        We confirm that the password can be used to establish an administrative WinRM session on DC01:
                    </p>
                    <img class="img-fluid" src="../assets/img/attck_1/23.png" alt="..." />
                    <p></p>
                    <h2 id="conclusion">Conclusion</h2>
                    <p>
                        Everything is now configured properly for us to perform our assessment. 
                        All settings, other than the modifications shown here and those applied
                         during the initial configuration were left to their default installation 
                         settings. We will be taking snapshots of each machine 
                         to preserve their configuration. Using snapshots we previously took of the 
                         base configuration, we will be able to configure additional attack chains 
                         without modifying this one.
                    </p>
                </div>
            </div>
        </div>
    </article>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core theme JS-->
    <script src="js/scripts.js"></script>
</body>

</html>